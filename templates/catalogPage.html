{% extends "index.html" %}

{% load static %}
{% block styles %}
<link rel="stylesheet" href="{% static 'css/catalogPageStyles.css' %}">
{% endblock %}

{% block title %}Catalog{% endblock %}

{% block main %}
{% csrf_token %}
<input type="hidden" id="csrf_token" value="{{ csrf_token }}">

<section class="productSideBar">
  <div class="leftFilterBar">
    <div class="filter-dropdown">
      <button id="filterToggle" aria-haspopup="true" aria-expanded="false">Filter</button>
      <div class="filter-menu" id="filterMenu" hidden>
        <form id="filterForm">
          <fieldset class="filter-group">
            <legend>Price</legend>
            <label>
              Min:
              <input type="number" name="price_min" id="priceMin" min="0" step="0.01" placeholder="0">
            </label>
            <br>
            <label>
              Max:
              <input type="number" name="price_max" id="priceMax" min="0" step="0.01" placeholder="1000">
            </label>
          </fieldset>

          <fieldset class="filter-group">
            <legend>Category</legend>
            <div id="categoryOptions">
              <p class="placeholder">No categories available</p>
            </div>
          </fieldset>

          <fieldset class="filter-group">
            <legend>Brand</legend>
            <div id="brandOptions">
              <p class="placeholder">No brands available</p>
            </div>
          </fieldset>

          <div class="filter-actions">
            <button type="submit" id="applyFilters">Apply</button>
            <button type="button" id="clearFilters">Clear</button>
          </div>
        </form>
      </div>
    </div>

    <button id="sortPriceBtn">Order By Price</button>
  </div>
</section>

<section class="productSection">
  <h1>Products</h1>

    {% if request.user.is_authenticated and request.user.is_staff %}
        <a href="{% url 'add_product' %}" 
        class="button addProductBtn">
        + Add Product
        </a>
    {% endif %}

  <div class="search-container">
    <input type="text" id="productSearch" class="search-input" placeholder="Search products...">
  </div>

  <div class="ProductsContainer" id="productsContainer">
    {% for product in products %}
    <div class="ProductCard" data-price="{{ product.price }}" data-category="{{ product.category|default:'' }}"
      data-brand="{{ product.brand|default:'' }}" data-img="{{ product.image_url|default:'#' }}" data-id="{{ product.id }}">

      <a href="{% url 'product' productId=product.id %}">
        <img class="ProductImage" src="{{ product.image_url|default:'#' }}" alt="{{ product.name }}">
      </a>
      <a href="{% url 'product' productId=product.id %}">
        <h2 class="productTitle">{{ product.name }}</h2>
      </a>

      <div class="priceAndButtonDiv">
        <span class="productPrice">${{ product.price }}</span>
        <button class="button add-to-cart-btn">Add to Cart</button>
      </div>
    </div>
    {% empty %}
    <p>No products available.</p>
    {% endfor %}
  </div>
</section>

<script>
  (function () {
    // Existing references
    const queryString = window.location.search;
    const urlParams = new URLSearchParams(queryString);
    const category = urlParams.get('category')

    const filterToggle = document.getElementById('filterToggle');
    const filterMenu = document.getElementById('filterMenu');
    const filterForm = document.getElementById('filterForm');
    const categoryOptions = document.getElementById('categoryOptions');
    const brandOptions = document.getElementById('brandOptions');
    const priceMinEl = document.getElementById('priceMin');
    const priceMaxEl = document.getElementById('priceMax');
    
    // Dynamic references (will be updated after AJAX)
    let productsContainer = document.querySelectorAll('.ProductCard');
    let products = Array.from(document.querySelectorAll('.ProductCard') || []);

    function toggleFilterMenu() {
      const expanded = filterToggle.getAttribute('aria-expanded') === 'true';
      filterToggle.setAttribute('aria-expanded', String(!expanded));
      filterMenu.hidden = expanded;
    }

    filterToggle.addEventListener('click', function (e) {
      e.stopPropagation();
      toggleFilterMenu();
    });

    document.addEventListener('click', function () {
      filterToggle.setAttribute('aria-expanded', 'false');
      filterMenu.hidden = true;
    });

    filterMenu.addEventListener('click', function (e) {
      e.stopPropagation();
    });

    function populateOptions() {
      const categories = new Set();
      const brands = new Set();

      // Refresh container reference
      productsContainer = document.querySelectorAll('.ProductCard');
      
      productsContainer.forEach(card => {
        const c = (card.dataset.category || '').trim();
        const b = (card.dataset.brand || '').trim();
        if (c) categories.add(c);
        if (b) brands.add(b);
      });

      function buildCheckboxList(container, items, namePrefix) {
        container.innerHTML = '';
        if (items.size === 0) {
          const p = document.createElement('p');
          p.className = 'placeholder';
          p.textContent = 'No options available';
          container.appendChild(p);
          return;
        }
        Array.from(items).sort().forEach((val, idx) => {
          const id = `${namePrefix}_${idx}`;
          const label = document.createElement('label');
          label.setAttribute('for', id);
          const input = document.createElement('input');
          input.type = 'checkbox';
          input.name = namePrefix;
          input.checked = (namePrefix === 'category' && val.toLowerCase() === category);
          input.value = val;
          input.id = id;
          label.appendChild(input);
          label.appendChild(document.createTextNode(' ' + val));
          container.appendChild(label);
          container.appendChild(document.createElement('br'));
        });
      }

      buildCheckboxList(categoryOptions, categories, 'category');
      buildCheckboxList(brandOptions, brands, 'brand');
    }

    function applyFilters(e) {
      if (e) e.preventDefault();

      const priceMin = parseFloat(document.getElementById('priceMin').value);
      const priceMax = parseFloat(document.getElementById('priceMax').value);

      const selectedCategories = Array.from(filterForm.querySelectorAll('input[name="category"]:checked')).map(i => i.value);
      const selectedBrands = Array.from(filterForm.querySelectorAll('input[name="brand"]:checked')).map(i => i.value);

      // Refresh reference
      productsContainer = document.querySelectorAll('.ProductCard');
      
      productsContainer.forEach(card => {
        let show = true;
        const price = parseFloat(card.dataset.price);
        const category = (card.dataset.category || '').trim();
        const brand = (card.dataset.brand || '').trim();

        if (!Number.isNaN(priceMin) && price < priceMin) show = false;
        if (!Number.isNaN(priceMax) && price > priceMax) show = false;

        if (selectedCategories.length > 0 && !selectedCategories.includes(category)) show = false;
        if (selectedBrands.length > 0 && !selectedBrands.includes(brand)) show = false;

        card.style.display = show ? '' : 'none';
      });
    }

    function clearFilters() {
      filterForm.reset();
      productsContainer = document.querySelectorAll('.ProductCard');
      productsContainer.forEach(card => card.style.display = '');
    }

    function setPriceBounds() {
      // Refresh list
      products = Array.from(document.querySelectorAll('.ProductCard') || []);
      
      const prices = products
        .map(card => parseFloat(card.dataset.price))
        .filter(n => !Number.isNaN(n));
      if (!prices.length) {
        if (priceMinEl) priceMinEl.disabled = true;
        if (priceMaxEl) priceMaxEl.disabled = true;
        return;
      }
      const min = Math.min(...prices);
      const max = Math.max(...prices);

      if (priceMinEl) {
        priceMinEl.disabled = false;
        priceMinEl.min = min;
        priceMinEl.max = max;
        priceMinEl.placeholder = min.toFixed(2);
      }
      if (priceMaxEl) {
        priceMaxEl.disabled = false;
        priceMaxEl.min = min;
        priceMaxEl.max = max;
        priceMaxEl.placeholder = max.toFixed(2);
      }
    }

    function clampOnBlur(input) {
      if (!input) return;
      input.addEventListener('blur', () => {
        if (input.disabled || input.value === '') return;
        let v = parseFloat(input.value);
        if (Number.isNaN(v)) { input.value = ''; return; }
        const min = input.hasAttribute('min') ? parseFloat(input.min) : -Infinity;
        const max = input.hasAttribute('max') ? parseFloat(input.max) : Infinity;
        if (v < min) v = min;
        if (v > max) v = max;
        input.value = v.toFixed(2);
      });
    }

    // --- AJAX Search Implementation ---
    const searchInput = document.getElementById('productSearch');
    let debounceTimer;

    searchInput.addEventListener('input', function(e) {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => {
        const query = e.target.value;
        const url = new URL(window.location.href);
        url.searchParams.set('search', query);

        fetch(url, {
          headers: {
            'X-Requested-With': 'XMLHttpRequest'
          }
        })
        .then(response => response.text())
        .then(html => {
          // Parse the returned HTML
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, 'text/html');
          const newContainer = doc.querySelector('.ProductsContainer');
          
          if (newContainer) {
            const currentContainer = document.querySelector('.ProductsContainer');
            currentContainer.innerHTML = newContainer.innerHTML;
            
            // Re-initialize filter logic with new elements
            productsContainer = document.querySelectorAll('.ProductCard');
            products = Array.from(productsContainer);
            
            // Re-run setup functions
            populateOptions();
            setPriceBounds();
            
            // Re-apply any active client-side filters
            applyFilters();
          }
        })
        .catch(err => console.error('Search failed', err));
      }, 300); // 300ms debounce
    });

    // Initial Setup
    setPriceBounds();
    clampOnBlur(priceMinEl);
    clampOnBlur(priceMaxEl);
    populateOptions();
    filterForm.addEventListener('submit', applyFilters);
    document.getElementById('clearFilters').addEventListener('click', clearFilters);
    
    // Simulate click to set initial state if needed
    const applyBtn = document.getElementById("applyFilters");
    if(applyBtn) applyBtn.click();

  })();
</script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Changed to Event Delegation to support AJAX loaded elements
    const container = document.querySelector('.ProductsContainer');
    
    if (container) {
        container.addEventListener('click', function(e) {
            if (e.target && e.target.classList.contains('add-to-cart-btn')) {
                const btn = e.target;
                const card = btn.closest(".ProductCard");
                const productId = card.dataset.id; 
                const title = card.querySelector(".productTitle").textContent.trim();
                
                // Check if csrf token exists safely
                const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
                const csrfToken = csrfInput ? csrfInput.value : '';

                const price = card.dataset.price;
                const img = card.dataset.img;
                const item = {
                  title: title,
                  price: price,
                  img: img
                };

                // Use the global functions from functions.js (assuming they exist globally)
                if (typeof getCart === 'function' && typeof saveCart === 'function') {
                    const cart = getCart();
                    cart.push(item);
                    saveCart(cart);
                }

                // AJAX Call
                fetch('/api/cart/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ 'product_id': productId })
                })
                .then(response => {
                    if (response.ok) {
                        console.log("Saved to database!");
                    } else {
                        console.log("User not logged in or error occurred.");
                    }
                })
                .catch(err => console.error(err));

                alert("Added " + title + " to cart!");
            }
        });
    }
  });
</script>
{% endblock %}
