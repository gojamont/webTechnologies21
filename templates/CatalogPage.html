{% extends "index.html" %}

{% load static %}
{% block styles %}<link rel="stylesheet" href="{% static 'css/catalogPageStyles.css' %}">{% endblock %}

{% block title %}Catalog{% endblock %}

{% block main %}
  <section class="productSideBar">
        <div class="leftFilterBar">
            <div class="filter-dropdown">
                <button id="filterToggle" aria-haspopup="true" aria-expanded="false">Filter</button>
                <div class="filter-menu" id="filterMenu" hidden>
                    <form id="filterForm">
                        <fieldset class="filter-group">
              <legend>Price</legend>
              <label>Min:
                <input type="number" name="price_min" id="priceMin" step="0.01" placeholder="">
              </label>
              <label>Max:
                <input type="number" name="price_max" id="priceMax" step="0.01" placeholder="">
              </label>
                        </fieldset>

                        <fieldset class="filter-group">
                            <legend>Category</legend>
                            <div id="categoryOptions">
                                <!-- Categories will be populated from product data (client-side) -->
                                <p class="placeholder">No categories available</p>
                            </div>
                        </fieldset>

                        <fieldset class="filter-group">
                            <legend>Brand</legend>
                            <div id="brandOptions">
                                <!-- Brands will be populated from product data (client-side) -->
                                <p class="placeholder">No brands available</p>
                            </div>
                        </fieldset>

                        <div class="filter-actions">
                            <button type="submit" id="applyFilters">Apply</button>
                            <button type="button" id="clearFilters">Clear</button>
                        </div>
                    </form>
                </div>
            </div>

            <button id="sortPriceBtn">Order By Price</button>
        </div>
    </section>

      <section class="productSection">
        <h1>Products</h1>
        <div class="ProductsContainer">
            {% for product in products %}
            <div class="ProductCard" data-price="{{ product.price }}" data-category="{{ product.category|default:'' }}" data-brand="{{ product.brand|default:'' }}">
      <img class="ProductImage" src="{{ product.image_url }}" alt="{{ product.name }}">
                <p class="productTitle">{{ product.name }}</p>
                <strong><p class="productPrice">${{ product.price }}</p></strong>
            </div>
            {% empty %}
            <p>No products available.</p>
            {% endfor %}
        </div>
    </section>

    <script>
    (function() {
    const toggle = id => document.getElementById(id);
    const filterToggle = toggle('filterToggle');
    const filterMenu = toggle('filterMenu');
    const priceMin = toggle('priceMin');
    const priceMax = toggle('priceMax');
    const products = Array.from(document.querySelectorAll('.ProductCard'));
    const filterForm = document.getElementById('filterForm');
    const categoryOptions = document.getElementById('categoryOptions');
    const brandOptions = document.getElementById('brandOptions');

      function toggleFilterMenu() {
        const expanded = filterToggle.getAttribute('aria-expanded') === 'true';
        filterToggle.setAttribute('aria-expanded', String(!expanded));
        if (expanded) {
          filterMenu.hidden = true;
        } else {
          filterMenu.hidden = false;
        }
      }

      filterToggle.addEventListener('click', function(e) {
        e.stopPropagation();
        toggleFilterMenu();
      });

      //close dropdown when clicking outside
      document.addEventListener('click', function() {
        filterToggle.setAttribute('aria-expanded', 'false');
        filterMenu.hidden = true;
      });

      filterMenu.addEventListener('click', function(e) {
        e.stopPropagation();
      });
    // set min/max attributes (no visible text)
    function setPriceBounds(){
      const prices = products.map(p => parseFloat(p.dataset.price)).filter(n => !Number.isNaN(n));
      if (!prices.length) {
        priceMin.disabled = priceMax.disabled = true;
        return;
      }
      const min = Math.min(...prices);
      const max = Math.max(...prices);
      priceMin.disabled = priceMax.disabled = false;
      priceMin.min = min; priceMin.max = max; priceMin.placeholder = min.toFixed(2);
      priceMax.min = min; priceMax.max = max; priceMax.placeholder = max.toFixed(2);
    }

    // Clamp and normalize on blur
    function clampInput(input){
      input.addEventListener('blur', () => {
        if (input.disabled || input.value === '') return;
        let v = parseFloat(input.value);
        if (Number.isNaN(v)) { input.value = ''; return; }
        const min = input.hasAttribute('min') ? parseFloat(input.min) : -Infinity;
        const max = input.hasAttribute('max') ? parseFloat(input.max) : Infinity;
        if (v < min) v = min;
        if (v > max) v = max;
        input.value = v.toFixed(2);
      });
    }

    setPriceBounds();
    clampInput(priceMin); clampInput(priceMax);

    // client-side filter apply/clear
    filterForm.addEventListener('submit', e => {
      e.preventDefault();
      const min = parseFloat(priceMin.value);
      const max = parseFloat(priceMax.value);
      products.forEach(card => {
        const p = parseFloat(card.dataset.price);
        let show = true;
        if (!Number.isNaN(min) && p < min) show = false;
        if (!Number.isNaN(max) && p > max) show = false;
        card.style.display = show ? '' : 'none';
      });
    });

    document.getElementById('clearFilters').addEventListener('click', () => {
      priceMin.value = priceMax.value = '';
      products.forEach(c => c.style.display = '');
    });
      // from productcards data attrs
      function populateOptions() {
        const categories = new Set();
        const brands = new Set();

        products.forEach(card => {
          const c = (card.dataset.category || '').trim();
          const b = (card.dataset.brand || '').trim();
          if (c) categories.add(c);
          if (b) brands.add(b);
        });

        function buildCheckboxList(container, items, namePrefix) {
          container.innerHTML = '';
          if (items.size === 0) {
            const p = document.createElement('p');
            p.className = 'placeholder';
            p.textContent = 'No options available';
            container.appendChild(p);
            return;
          }
          Array.from(items).sort().forEach((val, idx) => {
            const id = `${namePrefix}_${idx}`;
            const label = document.createElement('label');
            label.setAttribute('for', id);
            const input = document.createElement('input');
            input.type = 'checkbox';
            input.name = namePrefix;
            input.value = val;
            input.id = id;
            label.appendChild(input);
            label.appendChild(document.createTextNode(' ' + val));
            container.appendChild(label);
            container.appendChild(document.createElement('br'));
          });
        }

        buildCheckboxList(categoryOptions, categories, 'category');
        buildCheckboxList(brandOptions, brands, 'brand');
      }

      // client-side
      function applyFilters(e) {
        if (e) e.preventDefault();

        const priceMin = parseFloat(document.getElementById('priceMin').value);
        const priceMax = parseFloat(document.getElementById('priceMax').value);

        const selectedCategories = Array.from(filterForm.querySelectorAll('input[name="category"]:checked')).map(i => i.value);
        const selectedBrands = Array.from(filterForm.querySelectorAll('input[name="brand"]:checked')).map(i => i.value);

        products.forEach(card => {
          let show = true;
          const price = parseFloat(card.dataset.price);
          const category = (card.dataset.category || '').trim();
          const brand = (card.dataset.brand || '').trim();

          if (!Number.isNaN(priceMin) && price < priceMin) show = false;
          if (!Number.isNaN(priceMax) && price > priceMax) show = false;

          if (selectedCategories.length > 0 && !selectedCategories.includes(category)) show = false;
          if (selectedBrands.length > 0 && !selectedBrands.includes(brand)) show = false;

          card.style.display = show ? '' : 'none';
        });
      }

      function clearFilters() {
        filterForm.reset();
        products.forEach(card => card.style.display = '');
      }

      populateOptions();
      filterForm.addEventListener('submit', applyFilters);
      document.getElementById('clearFilters').addEventListener('click', clearFilters);

      // if products are updated later, call populateOptions() again.
    })();
    </script>
{% endblock %}
