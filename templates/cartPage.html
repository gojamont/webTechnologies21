{% extends "index.html" %}

{% block title %}Your Cart{% endblock %}

{% block main %}
<section class="cartSection">
    <h1>Your Shopping Cart</h1>
    <div id="cartContainer">
        </div>
    <div id="cartTotal" style="margin-top:2em; font-weight:600;"></div>
    <div style="margin-top:1em; display:flex; gap:1em;">
        <button id="clearCartBtn" style="padding:0.5em 1em;">Clear Cart</button>
        <button id="checkoutBtn" style="padding:0.5em 1em; background:#2ecc71;color:white;border:none;border-radius:6px;cursor:pointer;" disabled>Checkout</button>
    </div>
</section>
<script>
document.addEventListener("DOMContentLoaded", function () {
    // getCart() and saveCart() are loaded from static/js/functions.js

    function renderCart() {
        const cart = getCart(); // This global function works
        const container = document.getElementById("cartContainer");
        const totalDiv = document.getElementById("cartTotal");
        const checkoutBtn = document.getElementById("checkoutBtn");
        container.innerHTML = "";
        let total = 0;

        if (cart.length === 0) {
            container.innerHTML = "<p>Your cart is empty.</p>";
            totalDiv.textContent = "";
            if (checkoutBtn) checkoutBtn.disabled = true;
            return;
        }

        cart.forEach((item, idx) => {
            total += parseFloat(item.price);
            const itemDiv = document.createElement("div");
            itemDiv.className = "cartItem";
            itemDiv.style.display = "flex";
            itemDiv.style.alignItems = "center";
            itemDiv.style.marginBottom = "1em";
            itemDiv.innerHTML = `
                <img src="${item.img}" alt="${item.title}" style="width:60px;height:60px;object-fit:cover;margin-right:1em;">
                <span style="flex:1;">${item.title}</span>
                <span style="margin-right:1em;">$${item.price}</span>
                <button data-idx="${idx}" class="removeCartBtn" style="background:#e74c3c;color:white;border:none;padding:0.5em 1em;border-radius:5px;">Remove</button>
            `;
            container.appendChild(itemDiv);
        });

        totalDiv.textContent = "Total: $" + total.toFixed(2);

        // enable checkout when there's at least one item
        if (checkoutBtn) checkoutBtn.disabled = false;

        // Attach remove handlers
        document.querySelectorAll(".removeCartBtn").forEach(btn => {
            btn.addEventListener("click", function () {
                const idx = parseInt(btn.getAttribute("data-idx"));
                const cart = getCart();
                cart.splice(idx, 1);
                saveCart(cart); // This global function works
                renderCart();
            });
        });
    }

    document.getElementById("clearCartBtn").addEventListener("click", function () {
        localStorage.removeItem("cart");
        renderCart();
    });

    // Checkout handler: navigate to /checkout (change to desired endpoint)
    const checkoutBtn = document.getElementById("checkoutBtn");
    if (checkoutBtn) {
        checkoutBtn.addEventListener("click", function () {
            const cart = getCart();
            if (!cart || cart.length === 0) {
                alert("Your cart is empty.");
                return;
            }
            // If you have a checkout page, go there:
            window.location.href = "/checkout";
            // Alternatively, implement an AJAX checkout/create-order call here.
        });
    }

    renderCart();
});
</script>
<style>
.cartSection {
    max-width: 600px;
    margin: 2em auto;
    padding: 2em;
    background: #f9f9f9;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}
.cartItem {
    border-bottom: 1px solid #ddd;
    padding-bottom: 1em;
}
</style>
{% endblock %}
