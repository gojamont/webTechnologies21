{% extends "index.html" %}

{% load static %}
{% block styles %}<link rel="stylesheet" href="{% static 'css/productPageStyles.css' %}">{% endblock %}

{% block title %}{{ product.name }}{% endblock %}

{% block main %}
{% csrf_token %}
<input type="hidden" id="csrf_token" value="{{ csrf_token }}">

<div>
    <img class="ProductImage" src="{{ product.image_url|default:'#' }}" alt="{{ product.name }}">
</div>
<div class="detailsDiv">
    <h1 class="productTitle">{{ product.name }}</h1>
    <strong><p class="productPrice">${{ product.price }}</p></strong>
    
    <button class="button add-to-cart-btn" 
            data-id="{{ product.id }}"
            data-title="{{ product.name }}"
            data-price="{{ product.price }}"
            data-img="{{ product.image_url|default:'#' }}">
        Add to Cart
    </button>
    
    <p class="productDescription">{{ product.description }}</p>
    
{% if request.user.is_authenticated and request.user.is_staff %}
    <a href="{% url 'edit_product' product.id %}"
   style="display:inline-block; margin-top:0.5em; padding:0.3em 0.7em;
          background:#1976d2; color:white; border-radius:4px; text-decoration:none;">
    Edit
</a>
{% endif %}

</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const btn = document.querySelector(".add-to-cart-btn");
        
        if (btn) {
            btn.addEventListener("click", function () {
                // Retrieve data directly from the button's attributes
                const productId = this.getAttribute('data-id');
                const title = this.getAttribute('data-title');
                const price = this.getAttribute('data-price');
                const img = this.getAttribute('data-img');
                
                
                const csrfToken = document.getElementById('csrf_token').value;

             
                const item = {
                    title: title,
                    price: price,
                    img: img
                };
                const cart = getCart();
                cart.push(item);
                saveCart(cart);

                
                fetch('/api/cart/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ 'product_id': productId })
                })
                .then(response => {
                    if (response.ok) {
                        console.log("Saved to database!");
                    } else {
                        console.log("User not logged in or error occurred.");
                    }
                })
                .catch(err => console.error(err));

                alert("Added " + title + " to cart!");
            });
        }
    });
</script>
{% endblock %}